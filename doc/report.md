---
title: 药片装瓶设计报告
author: 周嘉豪
date: 2022-06-03

papersize: A4
mainfont: Times New Roman
CJKmainfont: SimSun
CJKoptions: AutoFakeBold, AutoFakeSlant
fontsize: 12pt
numbersections: false
lang: zh-CN
babel-lang: chinese-simplified
header-includes:
  - \usepackage{indentfirst}
  - \setlength{\parindent}{2em}
  - \usepackage{hanging}
---

# 功能

- 设置模式
  * 设置药瓶数和每瓶药片数
  * 设置模式下显示闪烁
  * 指示灯指示显示的内容
- 工作模式
  * 查看总数、药瓶数、药片数和初始设置
  * 工作模式下显示不闪烁
  * 指示灯指示显示的内容和工作是否完成
  * 装瓶计数
  * 完成时蜂鸣器报警

# 实现逻辑

- 工作模式计数
  * 3个BCD码计数器，分别记录总数、药瓶数、药片数
  * 总数和药片数计数器对药片脉冲计数
  * 药瓶数计数器根据药片数计数器进位计数
  * 根据设置数据调整模值
- 设置模式调整
  * 2个BCD码计数器，分别记录药瓶数设置、药片数设置
  * 计数器计数`+1`按键按下次数，并接收重置按键作为重置信号
  * 状态选择决定哪个计数器处理输入
- 状态选择逻辑
  * 记录当前所处的模式和所选择的显示量
  * 通过模式切换和选择切换按键切换

# 引脚连接

输入信号：

- `clk`：50MHz外部时钟
- `key_n[4:1]`：机械按键4~1，低有效
- `reset_n`：机械按键`RESET`，全局重置信号，低有效

输出信号：

- `led_n[4:1]`：LED 4~1，低有效
- `ledsd_bl`：74HC595输出使能，数码管显示使能，低使能
- `ledsd_ds`：74HC595串行输入，数码管控制信号
- `ledsd_shcp`：74HC595移位时钟
- `ledsd_stcp`：74HC595存储时钟

# 调试日志

## 2022-04-21

进行测试时，发现硬件行为与模拟行为不一致。硬件在时序上超前模拟结果一个时钟周期。暂时以硬件行为为准设计其余模块。

## 2022-04-25

重新研究SystemVerilog语法后发现，在寄存器描述中不正确的使用了阻塞赋值。模拟器模拟了阻塞赋值行为，但综合器生成的硬件设计并未严格遵循这一行为，原因未知。改正后问题消失。

## 2022-04-27

测试时发现按键工作不正常，按键应当仅在按下时产生一次脉冲，但实际测试时，按下和释放时都表现为产生多次脉冲。怀疑与消抖动电路有关。用Signal Trap记录按键按下前后信号变化，发现发出多次脉冲。

## 2022-04-28

进一步跟踪消抖器内部信号，发现计数器计数逻辑有严重错误，导致消抖功能基本失效。按键信号频繁调变导致脉冲生成逻辑被错误触发，生成不应出现的错误脉冲。修正计数逻辑后，问题消失。

# 心得体会

设计一个相对复杂的项目，让我积累了一些和硬件设计相关的经验。我对阻塞和非阻塞赋值的行为有了更深的了解，尽管课程中讲过二者的区别，但只有实际操作过才真正意识到这一点。我对计数器的设计也有了一定经验，能够处理一些级联情况。我还注意到，对相同的硬件设计描述，模拟器和综合器可能有不一致的行为。这可能是因为某些描述的行为可以模拟，但难以有效的综合，因此综合器进行了一定的调整。因此，有必要使用实际硬件进行测试，而不能单纯依赖模拟。
